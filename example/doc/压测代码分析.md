# 压测代码分析

## 模拟游戏服务器

为了模拟游戏服务器接收压测请求,首先基于netty快速实现一个echo服务器,并添加随机几毫秒的扰动

### 消息格式定义

在example中,约定长连接中数据为4字节消息长度,4字节消息码,剩余为消息内容

netty提供了LengthFieldBasedFrameDecoder帮助处理消息分隔问题,让我们可以避免处理半包,粘包等问题

    创建一个最大长度512*1024字节,4位长度,不包含4字节长度位的数据的分解handler
    new LengthFieldBasedFrameDecoder(1024 * 512, 0, 4, 0, 4)
    
    tips:在不同的语言中,高低字节的顺序可能是不一样的,比如c#和java就不一样,在解析长度的时候可能需要设置高低位


### 插入式协议编解码

message接口

DataCodec接口

选择stringcodec实现simpleMessage

MsgDecoder:取出四字节长度的消息id,以及剩下的消息体,放入new出来的simpleMessage对象中

MsgEncoder:通过message接口获得消息字节组,将4字节总长度,4字节消息号,消息数据写到netty输出ByteBuf中

### 业务处理

正常的游戏服务器,会对消息id进行路由,分法消息到对应的业务和线程执行消息响应,但是gameRobot只是模拟,所以将客户端上传消息解析后反向传回客户端即可


#### 服务器延迟

为了模拟服务器的延迟,使用延时任务执行客户端消息返回,在延迟任务的选择上,netty自带一个时间轮延时器,